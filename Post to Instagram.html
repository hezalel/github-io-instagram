<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post to Instagram</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-100 via-pink-50 to-orange-100 p-4 flex items-center justify-center">
    <div class="w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-8">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-purple-500 via-pink-500 to-orange-500 p-3 rounded-xl">
                    <svg class="text-white" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">Post to Instagram</h1>
            </div>
            <button onclick="toggleSettings()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2 text-gray-600">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v6m0 6v6"></path>
                    <path d="M17 8.5l-5 5"></path>
                    <path d="M12 1v6"></path>
                    <path d="M5 8.5l5 5"></path>
                </svg>
                <span class="text-sm font-medium">Configure API Settings</span>
            </button>
        </div>

        <p class="text-gray-600 mb-6">
            Upload an image and caption to post to your Instagram account
        </p>

        <!-- Settings Panel -->
        <div id="settingsPanel" class="mb-6 p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200 hidden">
            <h3 class="font-semibold text-lg mb-4 text-gray-800">API Configuration</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Instagram User ID *
                    </label>
                    <input
                        type="text"
                        id="instagramUserId"
                        placeholder="17841428209741544"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Access Token *
                    </label>
                    <input
                        type="password"
                        id="accessToken"
                        placeholder="Your long-lived access token"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ImgBB API Key *
                    </label>
                    <input
                        type="password"
                        id="imgbbApiKey"
                        placeholder="Get free API key from imgbb.com/api"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                    />
                    <p class="text-sm text-gray-500 mt-1">
                        Get your free API key at <a href="https://api.imgbb.com/" target="_blank" rel="noopener noreferrer" class="text-purple-600 hover:underline">imgbb.com/api</a>
                    </p>
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                    <div class="flex items-start">
                        <svg class="text-yellow-600 mr-2 flex-shrink-0 mt-0.5" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p class="text-sm text-yellow-800">
                            <strong>Tip:</strong> Your credentials are stored in your browser's memory and never sent anywhere except to Instagram's API and ImgBB.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Upload -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Upload Image *
            </label>
            <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-purple-400 transition-colors cursor-pointer bg-gray-50">
                <input
                    type="file"
                    accept="image/jpeg,image/png"
                    onchange="handleImageSelect(event)"
                    class="hidden"
                    id="image-upload"
                />
                <label for="image-upload" class="cursor-pointer" id="uploadLabel">
                    <div class="space-y-4">
                        <div class="flex justify-center">
                            <div class="bg-gradient-to-br from-purple-400 to-pink-400 p-4 rounded-full">
                                <svg class="text-white" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </div>
                        </div>
                        <div>
                            <p class="text-lg font-semibold text-gray-700">
                                Click to upload or drag and drop
                            </p>
                            <p class="text-sm text-gray-500 mt-1">
                                JPG or PNG, max 8MB
                            </p>
                        </div>
                    </div>
                </label>
            </div>
        </div>

        <!-- Caption -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Caption (optional, max 2,200 characters)
            </label>
            <textarea
                id="caption"
                maxlength="2200"
                rows="5"
                oninput="updateCharCount()"
                placeholder="Write your caption here... #hashtags"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none resize-none"
            ></textarea>
            <div class="text-right text-sm text-gray-500 mt-1">
                <span id="charCount">0</span> / 2,200
            </div>
        </div>

        <!-- Message -->
        <div id="messageBox" class="mb-6 hidden"></div>

        <!-- Post Button -->
        <button
            onclick="postToInstagram()"
            id="postButton"
            class="w-full bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 text-white py-4 rounded-xl font-semibold text-lg hover:shadow-lg transform hover:scale-[1.02] transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2"
        >
            Post to Instagram
        </button>

        <!-- Info Note -->
        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-sm text-blue-800">
                <strong>Note:</strong> Make sure your Instagram account is a Business or Creator account and linked to a Facebook Page. Posts may take a few seconds to appear on Instagram.
            </p>
        </div>
    </div>

    <script>
        let selectedImage = null;
        let isPosting = false;

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        }

        function handleImageSelect(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 8 * 1024 * 1024) {
                    showMessage('error', 'Image must be less than 8MB');
                    return;
                }
                selectedImage = file;
                const reader = new FileReader();
                reader.onloadend = () => {
                    document.getElementById('uploadLabel').innerHTML = `
                        <div class="space-y-4">
                            <img src="${reader.result}" alt="Preview" class="max-h-64 mx-auto rounded-lg shadow-lg"/>
                            <p class="text-sm text-gray-600">Click to change image</p>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
                showMessage('', '');
                updateButtonState();
            }
        }

        function updateCharCount() {
            const caption = document.getElementById('caption').value;
            document.getElementById('charCount').textContent = caption.length;
        }

        function updateButtonState() {
            const button = document.getElementById('postButton');
            button.disabled = isPosting || !selectedImage;
        }

        function showMessage(type, text) {
            const messageBox = document.getElementById('messageBox');
            if (!text) {
                messageBox.classList.add('hidden');
                return;
            }

            let bgColor, borderColor, textColor, icon;
            
            if (type === 'success') {
                bgColor = 'bg-green-50';
                borderColor = 'border-green-200';
                textColor = 'text-green-800';
                icon = `<svg class="text-green-600 flex-shrink-0" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>`;
            } else if (type === 'info') {
                bgColor = 'bg-blue-50';
                borderColor = 'border-blue-200';
                textColor = 'text-blue-800';
                icon = `<svg class="text-blue-600 flex-shrink-0 animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="2" x2="12" y2="6"></line>
                    <line x1="12" y1="18" x2="12" y2="22"></line>
                    <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                    <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                    <line x1="2" y1="12" x2="6" y2="12"></line>
                    <line x1="18" y1="12" x2="22" y2="12"></line>
                    <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                    <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
                </svg>`;
            } else {
                bgColor = 'bg-red-50';
                borderColor = 'border-red-200';
                textColor = 'text-red-800';
                icon = `<svg class="text-red-600 flex-shrink-0" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>`;
            }

            messageBox.className = `mb-6 p-4 rounded-lg flex items-start gap-3 ${bgColor} border ${borderColor}`;
            messageBox.innerHTML = `${icon}<p class="${textColor}">${text}</p>`;
            messageBox.classList.remove('hidden');
        }

        async function uploadImageToImgBB(file) {
            const apiKey = document.getElementById('imgbbApiKey').value;
            
            try {
                // Convert file to base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result.split(',')[1];
                        resolve(base64String);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                
                // Create form data with base64 image
                const formData = new FormData();
                formData.append('key', apiKey);
                formData.append('image', base64);
                
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ImgBB error:', errorText);
                    throw new Error(`ImgBB upload failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || 'ImgBB upload failed');
                }
                
                if (!data.data || !data.data.url) {
                    throw new Error('Invalid response from ImgBB');
                }
                
                return data.data.url;
            } catch (error) {
                console.error('Upload error:', error);
                if (error.message.includes('Failed to fetch')) {
                    throw new Error('Network error: Please check your internet connection and ImgBB API key. Make sure you have a valid API key from https://api.imgbb.com/');
                }
                throw error;
            }
        }

        async function postToInstagram() {
            if (!selectedImage) {
                showMessage('error', 'Please select an image');
                return;
            }

            const instagramUserId = document.getElementById('instagramUserId').value;
            const accessToken = document.getElementById('accessToken').value;
            const imgbbApiKey = document.getElementById('imgbbApiKey').value;

            if (!instagramUserId || !accessToken || !imgbbApiKey) {
                showMessage('error', 'Please configure all credentials in settings');
                toggleSettings();
                return;
            }

            isPosting = true;
            updateButtonState();
            document.getElementById('postButton').innerHTML = `
                <svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="2" x2="12" y2="6"></line>
                    <line x1="12" y1="18" x2="12" y2="22"></line>
                    <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                    <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                    <line x1="2" y1="12" x2="6" y2="12"></line>
                    <line x1="18" y1="12" x2="22" y2="12"></line>
                    <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                    <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
                </svg>
                Posting...
            `;
            showMessage('', '');

            try {
                // Step 1: Upload image to ImgBB
                showMessage('info', 'Uploading image...');
                const imageUrl = await uploadImageToImgBB(selectedImage);
                
                // Step 2: Create media container on Instagram
                showMessage('info', 'Creating Instagram post...');
                const caption = document.getElementById('caption').value;
                const containerResponse = await fetch(
                    `https://graph.facebook.com/v18.0/${instagramUserId}/media`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            image_url: imageUrl,
                            caption: caption,
                            access_token: accessToken
                        })
                    }
                );

                const containerData = await containerResponse.json();

                if (containerData.error) {
                    throw new Error(containerData.error.message || 'Failed to create media container');
                }

                const creationId = containerData.id;

                // Step 3: Wait for Instagram to process the image
                showMessage('info', 'Processing image...');
                await new Promise(resolve => setTimeout(resolve, 3000));

                // Step 4: Publish the container
                showMessage('info', 'Publishing to Instagram...');
                const publishResponse = await fetch(
                    `https://graph.facebook.com/v18.0/${instagramUserId}/media_publish`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            creation_id: creationId,
                            access_token: accessToken
                        })
                    }
                );

                const publishData = await publishResponse.json();

                if (publishData.error) {
                    throw new Error(publishData.error.message || 'Failed to publish post');
                }

                showMessage('success', 'ðŸŽ‰ Successfully posted to Instagram!');
                
                // Reset form
                selectedImage = null;
                document.getElementById('image-upload').value = '';
                document.getElementById('uploadLabel').innerHTML = `
                    <div class="space-y-4">
                        <div class="flex justify-center">
                            <div class="bg-gradient-to-br from-purple-400 to-pink-400 p-4 rounded-full">
                                <svg class="text-white" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </div>
                        </div>
                        <div>
                            <p class="text-lg font-semibold text-gray-700">
                                Click to upload or drag and drop
                            </p>
                            <p class="text-sm text-gray-500 mt-1">
                                JPG or PNG, max 8MB
                            </p>
                        </div>
                    </div>
                `;
                document.getElementById('caption').value = '';
                updateCharCount();
                
            } catch (error) {
                showMessage('error', `Error: ${error.message}`);
            } finally {
                isPosting = false;
                updateButtonState();
                document.getElementById('postButton').innerHTML = 'Post to Instagram';
            }
        }
    </script>
</body>
</html>